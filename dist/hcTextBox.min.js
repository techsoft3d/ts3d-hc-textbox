var hcTextBox;(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{TextBoxManager:()=>s,TextBoxMarkupItem:()=>o,TextBoxOperator:()=>n});class i{static stemID=null;static sphereID=null;static async createMeshes(t,e,s){i.stemID=await i.createPinStemMeshData(t,e),i.sphereID=await i.createPinSphereMeshData(t,e,s)}static createPinTransformationMatrix(t,e,i){let s=0,o=e.x;Math.abs(e.y)<Math.abs(o)&&(o=e.y,s=1),Math.abs(e.z)<Math.abs(o)&&(s=2);const n=[0,0,0];n[s]=1;const a=Communicator.Point3.createFromArray(n),r=Communicator.Point3.cross(e,a).normalize(),h=Communicator.Point3.cross(e,r);let l=new Communicator.Matrix;return l.m=[e.x,e.y,e.z,0,r.x,r.y,r.z,0,h.x,h.y,h.z,0,0,0,0,1],l=Communicator.Matrix.multiply(l,(new Communicator.Matrix).setScaleComponent(i,i,i)),l.setTranslationComponent(t.x,t.y,t.z),l}static async createPinStemMeshData(t,e){const i=new Communicator.MeshData;return i.addPolyline([0,0,0,e,0,0]),await t.model.createMesh(i)}static async createPinStemInstance(t,e,s=Communicator.Color.black()){const o=i.stemID,n=new Communicator.MeshInstanceData(o,e,"pin-stem-instance",void 0,s);n.setOpacity(1);const a=Communicator.MeshInstanceCreationFlags.SuppressCameraScale|Communicator.MeshInstanceCreationFlags.DoNotCut|Communicator.MeshInstanceCreationFlags.DoNotExplode|Communicator.MeshInstanceCreationFlags.DoNotXRay|Communicator.MeshInstanceCreationFlags.ExcludeBounding|Communicator.MeshInstanceCreationFlags.OverrideSceneVisibility|Communicator.MeshInstanceCreationFlags.AlwaysDraw;return n.setCreationFlags(a),await t.model.createMeshInstance(n,void 0,!0,!0)}static async createPinSphereInstance(t,e,s=Communicator.Color.white()){const o=i.sphereID,n=new Communicator.MeshInstanceData(o,e,"pin-sphere-instance",s,void 0);n.setOpacity(1);const a=Communicator.MeshInstanceCreationFlags.SuppressCameraScale|Communicator.MeshInstanceCreationFlags.DoNotCut|Communicator.MeshInstanceCreationFlags.DoNotExplode|Communicator.MeshInstanceCreationFlags.DoNotXRay|Communicator.MeshInstanceCreationFlags.ExcludeBounding|Communicator.MeshInstanceCreationFlags.OverrideSceneVisibility|Communicator.MeshInstanceCreationFlags.AlwaysDraw;return n.setCreationFlags(a),await t.model.createMeshInstance(n,void 0,!0,!0)}static async createPinSphereMeshData(t,e,i){const s=(1+Math.sqrt(5))/2,o=Math.sqrt(10+2*Math.sqrt(5))/(4*s),n=o/2,a=o/(2*s),r=[];r[0]=new Communicator.Point3(-a,n,0),r[1]=new Communicator.Point3(a,n,0),r[2]=new Communicator.Point3(-a,-n,0),r[3]=new Communicator.Point3(a,-n,0),r[4]=new Communicator.Point3(0,-a,n),r[5]=new Communicator.Point3(0,a,n),r[6]=new Communicator.Point3(0,-a,-n),r[7]=new Communicator.Point3(0,a,-n),r[8]=new Communicator.Point3(n,0,-a),r[9]=new Communicator.Point3(n,0,a),r[10]=new Communicator.Point3(-n,0,-a),r[11]=new Communicator.Point3(-n,0,a);for(const t of r)t.normalize();let h=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],l=12;for(let t=0;t<i;t++){const t=[];h.map((e=>{const i=r[e[0]],s=r[e[1]],o=r[e[2]];r[l++]=new Communicator.Point3(i.x+s.x,i.y+s.y,i.z+s.z).scale(.5).normalize(),r[l++]=new Communicator.Point3(s.x+o.x,s.y+o.y,s.z+o.z).scale(.5).normalize(),r[l++]=new Communicator.Point3(o.x+i.x,o.y+i.y,o.z+i.z).scale(.5).normalize(),t.push([e[0],l-3,l-1]),t.push([l-3,l-2,l-1]),t.push([l-3,e[1],l-2]),t.push([l-2,e[2],l-1])})),h=t}const c=[],u=[];for(const t of h)for(let i=0;i<3;i++){const s=t[i],o=r[s];c.push(o.x+e+1),c.push(o.y),c.push(o.z);const n=o.normalize();u.push(n.x),u.push(n.y),u.push(n.z)}const d=new Communicator.MeshData;return d.addFaces(c,u),d.setFaceWinding(Communicator.FaceWinding.CounterClockwise),await t.model.createMesh(d)}}class s{constructor(t,e=!0){this._viewer=t,this._markups=[],this._useMarkupManager=e,this._markupUpdatedCallback=null,i.createMeshes(t,2,2);let s=this;this._useMarkupManager||(new ResizeObserver((function(){setTimeout((function(){s.refreshMarkup()}),250)})).observe(this._viewer.getViewElement()),this._viewer.setCallbacks({camera:function(){s.refreshMarkup(),setTimeout((function(){s.refreshMarkup()}),50)}})),this._viewer.setCallbacks({frameDrawn:function(t,e){for(let t=0;t<s._markups.length;t++)s._markups[t].getCheckVisibility()&&s._markups[t].hide();for(let t=0;t<e.length;t++)s.markupsToTestVisibility[e[t]].getCheckVisibility()&&s.markupsToTestVisibility[e[t]].getHidden()&&(s.markupsToTestVisibility[e[t]].show(),s.markupsToTestVisibility[e[t]].refreshText())}})}setMarkupUpdatedCallback(t){this._markupUpdatedCallback=t}getMarkupUpdatedCallback(){return this._markupUpdatedCallback}getUseMarkupManager(){return this._useMarkupManager}add(t){if(this._markups.push(t),this._useMarkupManager){let e=this._viewer.markupManager.registerMarkup(t);t.setMarkupId(e)}this.updateVisibilityList()}updateVisibilityList(){let t=[];this.markupsToTestVisibility=[];for(let e=0;e<this._markups.length;e++)this._markups[e].getCheckVisibility()&&(t.push(this._markups[e].getFirstPoint()),this.markupsToTestVisibility.push(this._markups[e]));this._viewer.view.setPointVisibilityTest(t)}deleteAll(){for(let t=0;t<this._markups.length;t++)this.getMarkupUpdatedCallback()&&this.getMarkupUpdatedCallback()(this._markups[t],!0),this._viewer.markupManager.unregisterMarkup(this._markups[t].getMarkupId()),this._markups[t].destroy();this._markups=[]}delete(t){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getUniqueId()==t){this.getMarkupUpdatedCallback()&&this.getMarkupUpdatedCallback()(this._markups[e],!0),this._viewer.markupManager.unregisterMarkup(this._markups[e].getMarkupId()),this._markups[e].destroy(),this._markups.splice(e,1);break}}getByID(t){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getUniqueId()==t)return this._markups[e]}getSelected(){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getSelected())return this._markups[t]}exportMarkup(){let t=[];for(let e=0;e<this._markups.length;e++)t.push(this._markups[e].toJson());return t}refreshMarkup(){if(this._useMarkupManager)this._viewer.markupManager.refreshMarkup();else for(let t=0;t<this._markups.length;t++)this._markups[t].draw()}pickMarkupItem(t){if(this._useMarkupManager)return this._viewer.markupManager.pickMarkupItem(t);for(let e=0;e<this._markups.length;e++)if(this._markups[e].hit(t))return this._markups[e];return null}loadData(t){for(let e=0;e<t.length;e++){let i=TextBoxMarkupItem.fromJson(this,t[e]);i.setAllowEditing(!1),this.add(i)}this.refreshMarkup()}isPinGeometry(t){for(let e=0;e<this._markups.length;e++)if(this._markups[e].isPinGeometry(t))return this._markups[e];return!1}hideAll(){for(let t=0;t<this._markups.length;t++)this._markups[t].hide();this.refreshMarkup()}setMouseClickPosition(t){this._mouseClickPosition=t}getMouseClickPosition(){return this._mouseClickPosition}}class o extends Communicator.Markup.MarkupItem{static fromJson(t,e){let i={secondPoint:Communicator.Point3.fromJson(e.secondPoint),secondPointRel:Communicator.Point2.fromJson(e.secondPointRel),font:e.font,fontSize:e.fontSize,backgroundColor:Communicator.Color.fromJson(e.backgroundColor),circleColor:Communicator.Color.fromJson(e.circleColor),circleRadius:e.circleRadius,maxWidth:e.maxWidth,fixed:e.fixed,extraDiv:e.extraDiv?e.extraDiv:null,uniqueid:e.uniqueid,userdata:e.userdata,showLeaderLine:e.showLeaderLine,allowFirstPointMove:e.allowFirstPointMove,allowSecondPointMove:e.allowSecondPointMove,hasPin:e.hasPin,pinSphereColor:Communicator.Color.fromJson(e.pinSphereColor),pinStemColor:Communicator.Color.fromJson(e.pinStemColor)},s=new o(t,Communicator.Point3.fromJson(e.firstPoint),i);return s.setText(decodeURIComponent(e.text)),s.setCheckVisibility(e.checkVisibility),s.deselect(),s}static _svgPointString(t){let e="";for(let i=0;i<t.length;i++)i&&(e+=" "),e+=t[i].x+","+t[i].y;return e}constructor(t,e,i){super(),this._textBoxManager=t,this._viewer=t._viewer,this._font=i&&i.fontStyle?i.fontStyle:"monospace",this._fontSize=i&&i.fontSize?i.fontSize:"12px",this._created=!0,i&&i.uniqueid?this._uniqueid=i.uniqueid:this._uniqueid=this._generateGUID(),this._backgroundColor=i&&i.backgroundColor?i.backgroundColor:new Communicator.Color(238,243,249),this._circleColor=i&&i.circleColor?i.circleColor:new Communicator.Color(128,128,255),this._circleRadius=i&&i.circleRadius?i.circleRadius:4,this._pinSphereColor=i&&i.pinSphereColor?i.pinSphereColor:new Communicator.Color(255,255,255),this._pinStemColor=i&&i.pinStemColor?i.pinStemColor:new Communicator.Color(0,0,0),this._firstPoint=e.copy(),this._allowEditing=!0,this._extraDiv=i&&i.extraDiv?i.extraDiv:null,this._userdata=i&&i.userdata?i.userdata:null,this._selected=!1,this._textHit=!0,this._maxWidth=i&&i.maxWidth?i.maxWidth:300,this._fixed=!(!i||!i.fixed)&&i.fixed,this._checkVisibility=!(!i||!i.checkVisibility)&&i.checkVisibility,this._lineGeometryShape=new Communicator.Markup.Shape.Polyline,this._circleGeometryShape=new Communicator.Markup.Shape.Circle,i&&null!=i.secondPoint?this._secondPoint=i.secondPoint.copy():this.setSecondPoint(e.copy()),i&&null!=i.secondPointRel&&(this._secondPointRel=i.secondPointRel.copy()),this._initialize(),this._hidden=!1,this._showLeaderLine=!i||!i.showLeaderLine||i.showLeaderLine,this._hasPin=!(!i||!i.hasPin)&&i.hasPin,this._pinSize=i&&i.pinSize?i.pinSize:.025,this._allowFirstPointMove=!i||!i.allowFirstPointMove||i.allowFirstPointMove,this._allowSecondPointMove=!i||!i.allowSecondPointMove||i.allowSecondPointMove}isPinGeometry(t){return!!this._hasPin&&(this._stemID==t||this._sphereID==t)}getAllowFirstPointMove(){return this._allowFirstPointMove}getAllowSecondPointMove(){return this._allowSecondPointMove}async setupPin(t,e){if(this._hasPin){let s=i.createPinTransformationMatrix(t,e,this._pinSize);this._stemID=await i.createPinStemInstance(this._viewer,s,this._pinStemColor),this._sphereID=await i.createPinSphereInstance(this._viewer,s,this._pinSphereColor);let o=await this._viewer.model.getNodeRealBounding(this._sphereID);this._firstPoint=o.center(),this._secondPoint=o.center(),this._allowFirstPointMove=!1}}show(){this._hidden&&(this._hidden=!1)}hide(){this._hidden||(this._hidden=!0)}getHidden(){return this._hidden}setCheckVisibility(t){this._checkVisibility=t,this._textBoxManager.updateVisibilityList(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}getCheckVisibility(){return this._checkVisibility}getUserData(){return this._userdata}getSelected(){return this._selected}setAllowEditing(t){this._allowEditing=t}getAllowEditing(){return this._allowEditing}destroy(){$(this._textBoxDiv).remove(),this._textBoxManager.getUseMarkupManager()||$(this._svgElement).remove(),this._hasPin&&(this._viewer.model.deleteNode(this._sphereID),this._viewer.model.deleteNode(this._stemID))}refreshText(){this._adjustTextBox(),this._textBoxManager.refreshMarkup()}setText(t){$(this._textBoxText).val(t),this._adjustTextBox(),this._textBoxManager.refreshMarkup()}setMarkupId(t){this._markupId=t}getMarkupId(){return this._markupId}getUniqueId(){return this._uniqueid}toJson(){return{uniqueid:this._uniqueid,font:this._font,fontSize:this._fontSize,backgroundColor:this._backgroundColor.toJson(),circleColor:this._circleColor.toJson(),circleRadius:this._circleRadius,firstPoint:this._firstPoint.toJson(),secondPoint:this._secondPoint.toJson(),secondPointRel:this._secondPointRel.toJson(),maxWidth:this._maxWidth,fixed:this._fixed,allowEditing:this._allowEditing,text:this._textBoxText?encodeURIComponent($(this._textBoxText).val()):"",userdata:this._userdata,checkVisibility:this._checkVisibility,showLeaderLine:this._showLeaderLine,allowFirstPointMove:this._allowFirstPointMove,allowSecondPointMove:this._allowSecondPointMove,hasPin:this._hasPin,pinSphereColor:this._pinSphereColor.toJson(),pinStemColor:this._pinStemColor.toJson()}}getExtraDiv(){return this._extraTextDiv}setFixed(t){t!=this._fixed&&(this._fixed&&this.setSecondPoint(this._firstPoint),this._textBoxManager.refreshMarkup(),this._fixed=t,this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this))}getFixed(){return this._fixed}setBackgroundColor(t){this._backgroundColor=t,$(this._textBoxDiv).css("background-color","rgb("+t.r+","+t.g+","+t.b+")")}setCircleColor(t){this._circleColor=t,this._textBoxManager.refreshMarkup()}draw(){this._hidden?$(this._textBoxDiv).css("display","none"):($(this._textBoxDiv).css("display","flex"),$(this._svgElement).css("display","block")),$(this._svgElement).empty();const t=this._viewer.markupManager.getRenderer(),e=this._viewer.view;this._lineGeometryShape.clearPoints(),this._hasPin&&!this._fixed&&(async()=>{let t=await this._viewer.model.getNodeRealBounding(this._sphereID);this._firstPoint=t.center(),this._allowSecondPointMove||(this._secondPoint=t.center())})();let i=Communicator.Point2.fromPoint3(e.projectPoint(this._firstPoint));this._lineGeometryShape.pushPoint(i),this._circleGeometryShape.setCenter(i);let s,o=this._getDivDimensions();this._fixed?s=new Communicator.Point2(this._secondPointRel.x*o.width,this._secondPointRel.y*o.height):(s=Communicator.Point2.fromPoint3(e.projectPoint(this._secondPoint)),this._secondPointRel=new Communicator.Point2(s.x/o.width,s.y/o.height));let n=parseInt($(this._textBoxDiv).css("width")),a=parseInt($(this._textBoxDiv).css("height")),r=new Communicator.Point2(0,0);i.x<=s.x?r.x=s.x:i.x>=s.x+n?r.x=s.x+n:Math.abs(i.x-(s.x+n/2))<n/4?r.x=s.x+n/2:i.x>s.x+n/2?r.x=s.x+n:r.x=s.x,i.y<=s.y?r.y=s.y:i.y>=s.y+a?r.y=s.y+a:Math.abs(i.y-(s.y+a/2))<a/4?r.y=s.y+a/2:i.y>s.y+a/2?r.y=s.y+a:r.y=s.y,this._showLeaderLine&&(this._lineGeometryShape.pushPoint(r),this._textBoxManager.getUseMarkupManager()?(this._hidden||t.drawPolyline(this._lineGeometryShape),this._hasPin&&this._hidden||t.drawCircle(this._circleGeometryShape)):(this._hidden||this._addPolylineElement(this._lineGeometryShape),this._hasPin&&this._hidden||this._addCircleElement(this._circleGeometryShape))),$(this._textBoxDiv).css("top",s.y+"px"),$(this._textBoxDiv).css("left",s.x+"px"),this._created&&($(this._textBoxDiv).css("opacity",""),this._created=!1)}hit(t){let e=parseInt($(this._textBoxDiv).css("left")),i=parseInt($(this._textBoxDiv).css("top")),s=parseInt(e)+parseInt($(this._textBoxDiv).css("width")),o=parseInt(i)+parseInt($(this._textBoxDiv).css("height"));if(!this._hidden){if(t.x>=e&&t.x<=s&&t.y>=i&&t.y<=o)return this._textHit=!0,!0;if(this._extraTextDiv){let s=$(this._extraTextDiv).position();e+=s.left,i+=s.top;let o=e+parseInt($(this._extraTextDiv).css("width")),n=i+parseInt($(this._extraTextDiv).css("height"));if(t.x>=e&&t.x<=o&&t.y>=i&&t.y<=n)return this._textHit=!0,!0}}if(!this._hasPin||!this._hidden){let n=Communicator.Point2.fromPoint3(this._viewer.view.projectPoint(this._firstPoint));if(e=n.x-7,i=n.y-7,s=n.x+7,o=n.y+7,t.x>=e&&t.x<=s&&t.y>=i&&t.y<=o)return this._textHit=!1,!0}return this.deselect(),!1}setSecondPoint(t){this._secondPoint=t.copy();let e=this._getDivDimensions(),i=this._viewer.view.projectPoint(this._secondPoint);this._secondPointRel=new Communicator.Point2(i.x/e.width,i.y/e.height),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}setFirstPoint(t){this._firstPoint=t.copy(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this),this._textBoxManager.updateVisibilityList()}getFirstPoint(){return this._firstPoint.copy()}getSecondPoint(){return this._secondPoint.copy()}select(){this._allowEditing&&($(this._textBoxText).attr("disabled",!1),$(this._textBoxText).focus(),$(this._textBoxDiv).css("pointer-events","auto")),$(this._textBoxDiv).css("outline-width","3px"),this._selected=!0}deselect(){$(this._textBoxText).attr("disabled",!0),$(this._textBoxDiv).css("pointer-events","none"),$(this._textBoxDiv).css("outline-width","1px"),this._selected=!1}unprojectTextAnchor(){let t=this._getDivDimensions();this._secondPoint=this._viewer.view.unprojectPoint(new Communicator.Point2(this._secondPointRel.x*t.width,this._secondPointRel.y*t.height),.5),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}_addPolylineElement(t){let e=o._svgPointString(t.getPoints()),i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",e),i.setAttributeNS(null,"fill","none"),i.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),i.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(i)}_addCircleElement(t){let e=t.getCenter(),i=t.getRadius(),s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttributeNS(null,"cx",e.x.toString()),s.setAttributeNS(null,"cy",e.y.toString()),s.setAttributeNS(null,"r",i.toString()),s.setAttributeNS(null,"fill","rgb("+this._circleColor.r+","+this._circleColor.g+","+this._circleColor.b+")"),s.setAttributeNS(null,"fill-opacity","1"),s.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),s.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(s)}_initialize(){this._lineGeometryShape.setStrokeWidth(1),this._circleGeometryShape.setFillColor(this._circleColor),this._circleGeometryShape.setRadius(this._circleRadius),this._setupTextDiv(),this._extraDiv&&($(this._textBoxDiv).append(this._extraDiv),this._extraTextDiv=$(this._textBoxDiv).children()[1]),this._setupSVGDiv(),this.select()}_setupTextDiv(){let t="";t+='<div id="'+this._uniqueid+'" style="z-index:1;max-width:'+this._maxWidth+"px;opacity:1.0;display:flex;outline-style:solid;outline-width:2px;position: absolute;",t+="top:0px; left: 0px;width:100px;outline-color: rgb(76, 135, 190);background-color: rgb("+this._backgroundColor.r+","+this._backgroundColor.g+","+this._backgroundColor.b+');">',t+='<textarea autofocus style="max-width:'+this._maxWidth+"px;margin: 1px 0px 3px 3px; resize: none;font-family:"+this._font+";font-size:"+this._fontSize+";height:"+(parseInt(this._fontSize)+3)+'px;position: relative;outline: none;border: none;word-break: break-word;padding: 0 0 0 0;background-color: transparent;width: 100px;flex-grow: 1;overflow: hidden;"></textarea>',t+="</div>",$("#measurecanvas").length||($("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="measurecanvas" width="420px" height="150px;"></canvas></div>'),document.getElementById("measurecanvas").getContext("2d").font=this._fontSize+" "+this._font),$(this._viewer.getViewElement().parentElement).append(t),this._textBoxDiv=$("#"+this._uniqueid),this._textBoxText=$(this._textBoxDiv).children()[0],$(this._textBoxText).on("input",(t=>{this._adjustTextBox(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}))}_setupSVGDiv(){this._textBoxManager.getUseMarkupManager()||(this._svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._viewer.getViewElement().parentElement.appendChild(this._svgElement),$(this._svgElement).css("position","absolute"),$(this._svgElement).css("pointer-events","none"),$(this._svgElement).css("width","100%"),$(this._svgElement).css("height","100%"))}_adjustTextBox(){let t=this._calculateMaxTextWidth();$(this._textBoxDiv).css("width",t.width+"px"),$(this._textBoxText).css("height","0px"),$(this._textBoxText).css("height",$(this._textBoxText)[0].scrollHeight+"px"),this._textBoxManager.refreshMarkup()}_calculateMaxTextWidth(){let t=document.getElementById("measurecanvas").getContext("2d"),e=$(this._textBoxText).val().split("\n"),i=0;for(let s=0;s<e.length;s++){let o=t.measureText(e[s]);o.width>i&&(i=o.width)}return i<90&&(i=90),{width:i+10}}_getDivDimensions(){return{width:$(this._viewer.getViewElement()).outerWidth(),height:$(this._viewer.getViewElement()).outerHeight()}}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}}class n{constructor(t,e=null){this._viewer=t,e?this._textBoxManager=e:(this._textBoxManager=new s(this._viewer),this._viewer.markupManager.registerMarkupTypeManager("TextBox",this._textBoxManager)),this._allowCreation=2,this._createMarkupItemCallback=null,this._mouseActivationCallback=null,this._markupConfig={},this._autoHide=!1}setMarkupConfig(t){this._markupConfig=t}getMarkupConfig(){return this._markupConfig}getAutoHide(){return this._autoHide}setAutoHide(t){this._autoHide=t}setAllowCreation(t){this._allowCreation=t}getTextBoxManager(){return this._textBoxManager}setCreateMarkupItemCallback(t){this._createMarkupItemCallback=t}setMouseActivationCallback(t){this._mouseActivationCallback=t}onMouseDown(t){if(this._handled=!1,this._mouseMoved=!1,this._textBoxManager.setMouseClickPosition(t.getPosition().copy()),!this._mouseActivationCallback&&t.getButton()==Communicator.Button.Left||this._mouseActivationCallback&&this._mouseActivationCallback(t)){const e=this._textBoxManager.pickMarkupItem(t.getPosition());e&&e instanceof o?(e.getFixed()&&e.unprojectTextAnchor(),this._offset=Communicator.Point2.subtract(t.getPosition(),this._viewer.view.projectPoint(e.getSecondPoint())),this._dClickTime=new Date,this._activeMarkupItem=e,this._handled=!0):this._allowCreation&&(this._addMarkupItem(t.getPosition()),1==this._allowCreation&&(this._allowCreation=0))}t.setHandled(this._handled)}onMouseMove(t){this._dClickTime=null,this._mouseMoved=!0,t.setHandled(this._handled),null!==this._activeMarkupItem&&this._handled&&this._updateActiveMarkupItem(t.getPosition())}onMouseUp(t){null!==this._dClickTime?this._activeMarkupItem.getHidden()?(this._activeMarkupItem.show(),this._textBoxManager.refreshMarkup()):this._activeMarkupItem.select():this._mouseMoved||this._autoHide&&this._textBoxManager.hideAll(),this._dClickTime=null,t.setHandled(this._handled),this._activeMarkupItem=null}async _addMarkupItem(t){const e=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),s=await this._viewer.view.pickFromPoint(t,i);if(null===s||s.overlayIndex())return;const n=s.getNodeId();let a=s.getPosition();const r=s.getFaceEntity();if(null===n||null===a||null===r)return;if(null===e.getNodeParent(n))return;this._mouseMoved=!0;let h=this._textBoxManager.isPinGeometry(n);if(h)return h.show(),this._textBoxManager.refreshMarkup(),void(this._handled=!0);this._createMarkupItemCallback?this._activeMarkupItem=this._createMarkupItemCallback(this._textBoxManager,a,this._markupConfig):this._activeMarkupItem=new o(this._textBoxManager,a,this._markupConfig),this._activeMarkupItem.setupPin(s.getPosition(),r.getNormal()),this._textBoxManager.add(this._activeMarkupItem),this._offset=new Communicator.Point2(0,0),this._updateActiveMarkupItem(t),this._handled=!0}async _updateActiveMarkupItem(t){if(null===this._activeMarkupItem)return;if(!this._activeMarkupItem._textHit){if(!this._activeMarkupItem.getAllowFirstPointMove())return;const e=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),s=await this._viewer.view.pickFromPoint(t,i);if(null===s||s.overlayIndex())return;const o=s.getNodeId(),n=s.getPosition(),a=s.getFaceEntity();let r=!0;if(null!==o&&null!==n&&null!==a||(r=!1),null===e.getNodeParent(o)&&(r=!1),r)this._activeMarkupItem.setFirstPoint(n);else{let e=this._viewer.view.getCamera(),i=e.getPosition(),s=e.getTarget(),o=Communicator.Point3.subtract(s,i).normalize(),n=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),o),a=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(t.x,t.y)),h=null;h=n.intersectsRay(r,a),h&&this._activeMarkupItem.setFirstPoint(new Communicator.Point3(a.x,a.y,a.z))}return void this._textBoxManager.refreshMarkup()}if(!this._activeMarkupItem.getAllowSecondPointMove())return;let e=this._viewer.view.getCamera(),i=e.getPosition(),s=e.getTarget(),o=Communicator.Point3.subtract(s,i).normalize(),n=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),o),a=new Communicator.Point3,r=this._viewer.view.raycastFromPoint(new Communicator.Point2(t.x-this._offset.x,t.y-this._offset.y)),h=null;h=n.intersectsRay(r,a),h&&(this._activeMarkupItem.setSecondPoint(new Communicator.Point3(a.x,a.y,a.z)),this._textBoxManager.refreshMarkup())}}hcTextBox=e})();