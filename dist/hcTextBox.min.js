var hcTextBox;(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{TextBoxManager:()=>i,TextBoxMarkupItem:()=>s,TextBoxOperator:()=>r});class i{constructor(t,e=!0){this._viewer=t,this._markups=[],this._useMarkupManager=e,this._markupUpdatedCallback=null;let i=this;this._useMarkupManager||(new ResizeObserver((function(){setTimeout((function(){i.refreshMarkup()}),250)})).observe(this._viewer.getViewElement()),this._viewer.setCallbacks({camera:function(){i.refreshMarkup(),setTimeout((function(){i.refreshMarkup()}),50)}})),this._viewer.setCallbacks({frameDrawn:function(t,e){for(let t=0;t<i._markups.length;t++)i._markups[t].getCheckVisibility()&&i._markups[t].hide();for(let t=0;t<e.length;t++)i.markupsToTestVisibility[e[t]].getCheckVisibility()&&i.markupsToTestVisibility[e[t]].getHidden()&&(i.markupsToTestVisibility[e[t]].show(),i.markupsToTestVisibility[e[t]].refreshText())}})}setMarkupUpdatedCallback(t){this._markupUpdatedCallback=t}getMarkupUpdatedCallback(){return this._markupUpdatedCallback}getUseMarkupManager(){return this._useMarkupManager}add(t){if(this._markups.push(t),this._useMarkupManager){let e=this._viewer.markupManager.registerMarkup(t);t.setMarkupId(e)}this.updateVisibilityList()}updateVisibilityList(){let t=[];this.markupsToTestVisibility=[];for(let e=0;e<this._markups.length;e++)this._markups[e].getCheckVisibility()&&(t.push(this._markups[e].getFirstPoint()),this.markupsToTestVisibility.push(this._markups[e]));this._viewer.view.setPointVisibilityTest(t)}delete(t){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getUniqueId()==t){this.getMarkupUpdatedCallback()&&this.getMarkupUpdatedCallback()(this._markups[e],!0),this._viewer.markupManager.unregisterMarkup(this._markups[e].getMarkupId()),this._markups[e].destroy(),this._markups.splice(e,1);break}}getByID(t){for(let e=0;e<this._markups.length;e++)if(this._markups[e].getUniqueId()==t)return this._markups[e]}getSelected(){for(let t=0;t<this._markups.length;t++)if(this._markups[t].getSelected())return this._markups[t]}exportMarkup(){let t=[];for(let e=0;e<this._markups.length;e++)t.push(this._markups[e].toJson());return t}refreshMarkup(){if(this._useMarkupManager)this._viewer.markupManager.refreshMarkup();else for(let t=0;t<this._markups.length;t++)this._markups[t].draw()}pickMarkupItem(t){if(this._useMarkupManager)return this._viewer.markupManager.pickMarkupItem(t);for(let e=0;e<this._markups.length;e++)if(this._markups[e].hit(t))return this._markups[e];return null}loadData(t){for(let e=0;e<t.length;e++){let i=TextBoxMarkupItem.fromJson(this,t[e]);i.setAllowEditing(!1),this.add(i)}this.refreshMarkup()}}class s extends Communicator.Markup.MarkupItem{static fromJson(t,e){let i=new s(t,Communicator.Point3.fromJson(e.firstPoint),Communicator.Point3.fromJson(e.secondPoint),Communicator.Point3.fromJson(e.secondPointRel),e.font,e.fontSize,Communicator.Color.fromJson(e.backgroundColor),Communicator.Color.fromJson(e.circleColor),e.circleRadius,e.maxWidth,e.pinned,e.extraDivText?e.extraDivText:null,e.uniqueid,e.userdata);return i.setText(decodeURIComponent(e.text)),i.setCheckVisibility(e.checkVisibility),i.deselect(),i}static svgPointString(t){let e="";for(let i=0;i<t.length;i++)i&&(e+=" "),e+=t[i].x+","+t[i].y;return e}constructor(t,e,i=null,s=null,r="monospace",n="12px",o=new Communicator.Color(238,243,249),a=new Communicator.Color(128,128,255),h=4,l=300,u=!1,c=null,_=null,d=null,x=!1){super(),this._textBoxManager=t,this._viewer=t._viewer,this._font=r,this._fontSize=n,this._uniqueid=_||this._generateGUID(),this._backgroundColor=o,this._circleColor=a,this._circleRadius=h,this._firstPoint=e.copy(),this._allowEditing=!0,this._extraDivText=c,this._userdata=d,this._selected=!1,this._textHit=!0,this._maxWidth=l,this._pinned=u,this._checkVisibility=x,this._lineGeometryShape=new Communicator.Markup.Shape.Polyline,this._circleGeometryShape=new Communicator.Markup.Shape.Circle,null!=i?this._secondPoint=i.copy():this.setSecondPoint(e.copy()),null!=s&&(this._secondPointRel=s.copy()),this._initialize(),this._hidden=!1}show(){this._hidden&&(this._hidden=!1,$(this._textBoxDiv).css("display","flex"),$(this._svgElement).css("display","block"))}hide(){this._hidden||(this._hidden=!0,$(this._textBoxDiv).css("display","none"),$(this._svgElement).css("display","none"))}getHidden(){return this._hidden}setCheckVisibility(t){this._checkVisibility=t,this._textBoxManager.updateVisibilityList(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}getCheckVisibility(){return this._checkVisibility}getUserData(){return this._userdata}getSelected(){return this._selected}setAllowEditing(t){this._allowEditing=t}getAllowEditing(){return this._allowEditing}destroy(){$(this._textBoxDiv).remove(),this._textBoxManager.getUseMarkupManager()||$(this._svgElement).remove()}refreshText(){this._adjustTextBox(),this._textBoxManager.refreshMarkup()}setText(t){$(this._textBoxText).val(t),this._adjustTextBox(),this._textBoxManager.refreshMarkup()}setMarkupId(t){this._markupId=t}getMarkupId(){return this._markupId}getUniqueId(){return this._uniqueid}toJson(){return{uniqueid:this._uniqueid,font:this._font,fontSize:this._fontSize,backgroundColor:this._backgroundColor.toJson(),circleColor:this._circleColor.toJson(),circleRadius:this._circleRadius,firstPoint:this._firstPoint.toJson(),secondPoint:this._secondPoint.toJson(),secondPointRel:this._secondPointRel.toJson(),maxWidth:this._maxWidth,pinned:this._pinned,allowEditing:this._allowEditing,text:this._textBoxText?encodeURIComponent($(this._textBoxText).val()):"",userdata:this._userdata,checkVisibility:this._checkVisibility}}getExtraDiv(){return this._extraTextDiv}setPinned(t){t!=this._pinned&&(this._pinned&&this.setSecondPoint(this._firstPoint),this._textBoxManager.refreshMarkup(),this._pinned=t,this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this))}getPinned(){return this._pinned}setBackgroundColor(t){this._backgroundColor=t,$(this._textBoxDiv).css("background-color","rgb("+t.r+","+t.g+","+t.b+")")}setCircleColor(t){this._circleColor=t,this._textBoxManager.refreshMarkup()}draw(){if(this._hidden)return;$(this._svgElement).empty();const t=this._viewer.markupManager.getRenderer(),e=this._viewer.view;this._lineGeometryShape.clearPoints();let i=Communicator.Point2.fromPoint3(e.projectPoint(this._firstPoint));this._lineGeometryShape.pushPoint(i),this._circleGeometryShape.setCenter(i);let s,r=this._getDivDimensions();this._pinned?s=new Communicator.Point2(this._secondPointRel.x*r.width,this._secondPointRel.y*r.height):(s=Communicator.Point2.fromPoint3(e.projectPoint(this._secondPoint)),this._secondPointRel=new Communicator.Point2(s.x/r.width,s.y/r.height));let n=parseInt($(this._textBoxDiv).css("width")),o=parseInt($(this._textBoxDiv).css("height")),a=new Communicator.Point2(0,0);i.x<=s.x+n/2?a.x=s.x:a.x=s.x+n,i.y<=s.y+o/2?a.y=s.y:a.y=s.y+o,this._lineGeometryShape.pushPoint(a),this._textBoxManager.getUseMarkupManager()?(t.drawPolyline(this._lineGeometryShape),t.drawCircle(this._circleGeometryShape)):(this._addPolylineElement(this._lineGeometryShape),this._addCircleElement(this._circleGeometryShape)),$(this._textBoxDiv).css("top",s.y+"px"),$(this._textBoxDiv).css("left",s.x+"px")}hit(t){if(this._hidden)return!1;let e=parseInt($(this._textBoxDiv).css("left")),i=parseInt($(this._textBoxDiv).css("top")),s=parseInt(e)+parseInt($(this._textBoxDiv).css("width")),r=parseInt(i)+parseInt($(this._textBoxDiv).css("height"));if(t.x>=e&&t.x<=s&&t.y>=i&&t.y<=r)return this._textHit=!0,!0;if(this._extraTextDiv){let s=$(this._extraTextDiv).position();e+=s.left,i+=s.top;let r=e+parseInt($(this._extraTextDiv).css("width")),n=i+parseInt($(this._extraTextDiv).css("height"));if(t.x>=e&&t.x<=r&&t.y>=i&&t.y<=n)return this._textHit=!0,!0}let n=Communicator.Point2.fromPoint3(this._viewer.view.projectPoint(this._firstPoint));return e=n.x-7,i=n.y-7,s=n.x+7,r=n.y+7,t.x>=e&&t.x<=s&&t.y>=i&&t.y<=r?(this._textHit=!1,!0):(this.deselect(),!1)}setSecondPoint(t){this._secondPoint=t.copy();let e=this._getDivDimensions(),i=this._viewer.view.projectPoint(this._secondPoint);this._secondPointRel=new Communicator.Point2(i.x/e.width,i.y/e.height),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}setFirstPoint(t){this._firstPoint=t.copy(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this),this._textBoxManager.updateVisibilityList()}getFirstPoint(){return this._firstPoint.copy()}getSecondPoint(){return this._secondPoint.copy()}select(){this._allowEditing&&($(this._textBoxText).attr("disabled",!1),$(this._textBoxText).focus(),$(this._textBoxDiv).css("pointer-events","auto")),$(this._textBoxDiv).css("outline-width","3px"),this._selected=!0}deselect(){$(this._textBoxText).attr("disabled",!0),$(this._textBoxDiv).css("pointer-events","none"),$(this._textBoxDiv).css("outline-width","1px"),this._selected=!1}unprojectTextAnchor(){let t=this._getDivDimensions();this._secondPoint=this._viewer.view.unprojectPoint(new Communicator.Point2(this._secondPointRel.x*t.width,this._secondPointRel.y*t.height),.5),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)}_addPolylineElement(t){let e=s.svgPointString(t.getPoints()),i=document.createElementNS("http://www.w3.org/2000/svg","polyline");i.setAttributeNS(null,"points",e),i.setAttributeNS(null,"fill","none"),i.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),i.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(i)}_addCircleElement(t){let e=t.getCenter(),i=t.getRadius(),s=document.createElementNS("http://www.w3.org/2000/svg","circle");s.setAttributeNS(null,"cx",e.x.toString()),s.setAttributeNS(null,"cy",e.y.toString()),s.setAttributeNS(null,"r",i.toString()),s.setAttributeNS(null,"fill","rgb("+this._circleColor.r+","+this._circleColor.g+","+this._circleColor.b+")"),s.setAttributeNS(null,"fill-opacity","1"),s.setAttributeNS(null,"stroke","rgb(0, 0, 0)"),s.setAttributeNS(null,"stroke-width","1"),$(this._svgElement)[0].appendChild(s)}_initialize(){this._lineGeometryShape.setStrokeWidth(1),this._circleGeometryShape.setFillColor(this._circleColor),this._circleGeometryShape.setRadius(this._circleRadius),this._setupTextDiv()}_setupTextDiv(){let t="";t+='<div id="'+this._uniqueid+'" style="z-index:1;max-width:'+this._maxWidth+"px;display:flex;outline-style:solid;outline-width:2px;position: absolute;",t+="top:0px; left: 0px;width:100px;outline-color: rgb(76, 135, 190);background-color: rgb("+this._backgroundColor.r+","+this._backgroundColor.g+","+this._backgroundColor.b+');">',t+='<textarea autofocus style="max-width:'+this._maxWidth+"px;margin: 1px 0px 3px 3px; resize: none;font-family:"+this._font+";font-size:"+this._fontSize+";height:"+(parseInt(this._fontSize)+3)+'px;position: relative;outline: none;border: none;word-break: break-word;padding: 0 0 0 0;background-color: transparent;width: 100px;flex-grow: 1;overflow: hidden;"></textarea>',t+="</div>",$("#measurecanvas").length||($("body").append('<div style="display:none;position:absolute;background: white; z-index:1000"><canvas id="measurecanvas" width="420px" height="150px;"></canvas></div>'),document.getElementById("measurecanvas").getContext("2d").font=this._fontSize+" "+this._font),$(this._viewer.getViewElement().parentElement).append(t),this._textBoxDiv=$("#"+this._uniqueid),this._textBoxText=$(this._textBoxDiv).children()[0],this._extraDivText&&($(this._textBoxDiv).append(this._extraDivText),this._extraTextDiv=$(this._textBoxDiv).children()[1]),this._textBoxManager.getUseMarkupManager()||(this._svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._viewer.getViewElement().parentElement.appendChild(this._svgElement),$(this._svgElement).css("position","absolute"),$(this._svgElement).css("pointer-events","none"),$(this._svgElement).css("width","100%"),$(this._svgElement).css("height","100%")),$(this._textBoxText).on("input",(t=>{this._adjustTextBox(),this._textBoxManager.getMarkupUpdatedCallback()&&this._textBoxManager.getMarkupUpdatedCallback()(this)})),this.select()}_adjustTextBox(){let t=this._calculateMaxTextWidth();$(this._textBoxDiv).css("width",t.width+"px"),$(this._textBoxText).css("height","0px"),$(this._textBoxText).css("height",$(this._textBoxText)[0].scrollHeight+"px"),this._textBoxManager.refreshMarkup()}_calculateMaxTextWidth(){let t=document.getElementById("measurecanvas").getContext("2d"),e=$(this._textBoxText).val().split("\n"),i=0;for(let s=0;s<e.length;s++){let r=t.measureText(e[s]);r.width>i&&(i=r.width)}return i<90&&(i=90),{width:i+10}}_getDivDimensions(){return{width:$(this._viewer.getViewElement()).outerWidth(),height:$(this._viewer.getViewElement()).outerHeight()}}_generateGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}}class r{constructor(t,e=null){this._viewer=t,e?this._textBoxManager=e:(this._textBoxManager=new i(this._viewer),this._viewer.markupManager.registerMarkupTypeManager("TextBox",this._textBoxManager)),this._allowCreation=2,this._createMarkupItemCallback=null,this._mouseActivationCallback=null}setAllowCreation(t){this._allowCreation=t}getTextBoxManager(){return this._textBoxManager}setCreateMarkupItemCallback(t){this._createMarkupItemCallback=t}setMouseActivationCallback(t){this._mouseActivationCallback=t}onMouseDown(t){if(this._handled=!1,!this._mouseActivationCallback&&t.getButton()==Communicator.Button.Left||this._mouseActivationCallback&&this._mouseActivationCallback(t)){const e=this._textBoxManager.pickMarkupItem(t.getPosition());e&&e instanceof s?(e.getPinned()&&e.unprojectTextAnchor(),this._offset=Communicator.Point2.subtract(t.getPosition(),this._viewer.view.projectPoint(e.getSecondPoint())),this._dClickTime=new Date,this._activeMarkupItem=e,this._handled=!0):this._allowCreation&&(this._addMarkupItem(t.getPosition()),1==this._allowCreation&&(this._allowCreation=0))}t.setHandled(this._handled)}onMouseMove(t){this._dClickTime=null,t.setHandled(this._handled),null!==this._activeMarkupItem&&this._handled&&this._updateActiveMarkupItem(t.getPosition())}onMouseUp(t){null!==this._dClickTime&&this._activeMarkupItem.select(),this._dClickTime=null,t.setHandled(this._handled),this._activeMarkupItem=null}async _addMarkupItem(t){const e=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),r=await this._viewer.view.pickFromPoint(t,i);if(null===r||r.overlayIndex())return;const n=r.getNodeId(),o=r.getPosition(),a=r.getFaceEntity();null!==n&&null!==o&&null!==a&&null!==e.getNodeParent(n)&&(this._createMarkupItemCallback?this._activeMarkupItem=this._createMarkupItemCallback(this._textBoxManager,o):this._activeMarkupItem=new s(this._textBoxManager,o),this._textBoxManager.add(this._activeMarkupItem),this._offset=new Communicator.Point2(0,0),this._updateActiveMarkupItem(t),this._handled=!0)}async _updateActiveMarkupItem(t){if(null===this._activeMarkupItem)return;if(!this._activeMarkupItem._textHit){const e=this._viewer.model,i=new Communicator.PickConfig(Communicator.SelectionMask.Face),s=await this._viewer.view.pickFromPoint(t,i);if(null===s||s.overlayIndex())return;const r=s.getNodeId(),n=s.getPosition(),o=s.getFaceEntity();let a=!0;if(null!==r&&null!==n&&null!==o||(a=!1),null===e.getNodeParent(r)&&(a=!1),a)this._activeMarkupItem.setFirstPoint(n);else{let e=this._viewer.view.getCamera(),i=e.getPosition(),s=e.getTarget(),r=Communicator.Point3.subtract(s,i).normalize(),n=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),r),o=new Communicator.Point3,a=this._viewer.view.raycastFromPoint(new Communicator.Point2(t.x,t.y)),h=null;h=n.intersectsRay(a,o),h&&this._activeMarkupItem.setFirstPoint(new Communicator.Point3(o.x,o.y,o.z))}return void this._textBoxManager.refreshMarkup()}let e=this._viewer.view.getCamera(),i=e.getPosition(),s=e.getTarget(),r=Communicator.Point3.subtract(s,i).normalize(),n=Communicator.Plane.createFromPointAndNormal(this._activeMarkupItem.getSecondPoint(),r),o=new Communicator.Point3,a=this._viewer.view.raycastFromPoint(new Communicator.Point2(t.x-this._offset.x,t.y-this._offset.y)),h=null;h=n.intersectsRay(a,o),h&&(this._activeMarkupItem.setSecondPoint(new Communicator.Point3(o.x,o.y,o.z)),this._textBoxManager.refreshMarkup())}}hcTextBox=e})();